<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{TITLE}}</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .plot-container {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background-color: #fff;
        }
        
        .plot-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #34495e;
        }
        
        .plot-description {
            color: #7f8c8d;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .plot-area {
            min-height: 400px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            pointer-events: none;
            z-index: 1000;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2em;
            color: #6c757d;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{TITLE}}</h1>
        
        <div id="plots-container">
            <!-- Dynamic plot containers will be inserted here -->
        </div>
    </div>

    <script>
        // Plot data from Rust
        const plotsData = {{PLOTS_DATA}};
        
        // Color schemes
        const colorSchemes = {
            Default: ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'],
            Viridis: ['#440154', '#482777', '#3f4a8a', '#31678e', '#26838f', '#1f9d8a', '#6cce5a', '#b6de2b', '#fee825'],
            Plasma: ['#0c0887', '#5302a3', '#8b0aa5', '#b83289', '#db5c68', '#f48849', '#febd2a', '#f0f921'],
            Magma: ['#000004', '#180f3d', '#440f76', '#721f81', '#9e2f7f', '#cd4071', '#f1605d', '#fd9668', '#fcfdbf'],
            Inferno: ['#000004', '#1b0c41', '#4a0c6b', '#781c6d', '#a52c60', '#cf4446', '#ed6925', '#fb9b06', '#fcffa4'],
            Blues: ['#08306b', '#08519c', '#2171b5', '#4292c6', '#6baed6', '#9ecae1', '#c6dbef', '#deebf7', '#f7fbff'],
            Reds: ['#67000d', '#a50f15', '#cb181d', '#ef3b2c', '#fb6a4a', '#fc9272', '#fcbba1', '#fee0d2', '#fff5f0'],
            Greens: ['#00441b', '#006d2c', '#238b45', '#41ab5d', '#74c476', '#a1d99b', '#c7e9c0', '#e5f5e0', '#f7fcf5']
        };

        // Initialize visualizations
        function initializeVisualizations() {
            const container = document.getElementById('plots-container');
            
            if (!Array.isArray(plotsData)) {
                container.innerHTML = '<div class="error">Invalid plot data format</div>';
                return;
            }

            plotsData.forEach((plot, index) => {
                const plotContainer = createPlotContainer(plot, index);
                container.appendChild(plotContainer);
                
                // Render the specific plot type
                renderPlot(plot, `plot-${index}`);
            });
        }

        // Create plot container HTML
        function createPlotContainer(plot, index) {
            const container = document.createElement('div');
            container.className = 'plot-container';
            container.innerHTML = `
                <div class="plot-title">${plot.config?.title || 'Visualization'}</div>
                <div class="plot-description">Interactive visualization with real-time updates</div>
                <div class="controls" id="controls-${index}">
                    <!-- Controls will be added based on plot type -->
                </div>
                <div class="plot-area" id="plot-${index}"></div>
            `;
            return container;
        }

        // Render plot based on type
        function renderPlot(plot, containerId) {
            if (plot.hasOwnProperty('importance_values')) {
                renderFeatureImportancePlot(plot, containerId);
            } else if (plot.hasOwnProperty('shap_values')) {
                renderShapPlot(plot, containerId);
            } else if (plot.hasOwnProperty('pd_values')) {
                renderPartialDependencePlot(plot, containerId);
            } else if (plot.hasOwnProperty('model_data')) {
                renderComparativePlot(plot, containerId);
            } else {
                document.getElementById(containerId).innerHTML = '<div class="error">Unknown plot type</div>';
            }
        }

        // Render feature importance plot
        function renderFeatureImportancePlot(plot, containerId) {
            const colors = getColors(plot.config?.color_scheme || 'Default');
            
            const trace = {
                x: plot.plot_type === 'Horizontal' ? plot.importance_values : plot.feature_names,
                y: plot.plot_type === 'Horizontal' ? plot.feature_names : plot.importance_values,
                type: plot.plot_type === 'Bar' || plot.plot_type === 'Horizontal' ? 'bar' : 'scatter',
                orientation: plot.plot_type === 'Horizontal' ? 'h' : 'v',
                marker: {
                    color: colors[0],
                    line: {
                        color: 'rgba(0,0,0,0.2)',
                        width: 1
                    }
                },
                name: 'Feature Importance'
            };

            // Add error bars if standard deviations are available
            if (plot.std_values) {
                if (plot.plot_type === 'Horizontal') {
                    trace.error_x = {
                        type: 'data',
                        array: plot.std_values,
                        visible: true
                    };
                } else {
                    trace.error_y = {
                        type: 'data',
                        array: plot.std_values,
                        visible: true
                    };
                }
            }

            const layout = {
                title: plot.config?.title || 'Feature Importance',
                xaxis: {
                    title: plot.config?.x_label || (plot.plot_type === 'Horizontal' ? 'Importance' : 'Features'),
                    showgrid: plot.config?.show_grid !== false
                },
                yaxis: {
                    title: plot.config?.y_label || (plot.plot_type === 'Horizontal' ? 'Features' : 'Importance'),
                    showgrid: plot.config?.show_grid !== false
                },
                margin: { t: 50, r: 50, b: 100, l: 100 },
                showlegend: false
            };

            const config = {
                responsive: true,
                displayModeBar: plot.config?.interactive !== false,
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'feature_importance',
                    height: plot.config?.height || 600,
                    width: plot.config?.width || 800,
                    scale: 1
                }
            };

            Plotly.newPlot(containerId, [trace], layout, config);
        }

        // Render SHAP plot
        function renderShapPlot(plot, containerId) {
            const colors = getColors(plot.config?.color_scheme || 'Default');
            
            switch (plot.plot_type) {
                case 'Summary':
                    renderShapSummaryPlot(plot, containerId, colors);
                    break;
                case 'Waterfall':
                    renderShapWaterfallPlot(plot, containerId, colors);
                    break;
                case 'ForceLayout':
                    renderShapForceLayoutPlot(plot, containerId, colors);
                    break;
                default:
                    renderShapSummaryPlot(plot, containerId, colors);
            }
        }

        // Render SHAP summary plot
        function renderShapSummaryPlot(plot, containerId, colors) {
            const traces = [];
            
            for (let i = 0; i < plot.feature_names.length; i++) {
                const shapValues = [];
                const featureValues = [];
                
                for (let j = 0; j < plot.instance_names.length; j++) {
                    shapValues.push(plot.shap_values[j][i]);
                    featureValues.push(plot.feature_values[j][i]);
                }
                
                traces.push({
                    x: shapValues,
                    y: Array(shapValues.length).fill(plot.feature_names[i]),
                    mode: 'markers',
                    type: 'scatter',
                    marker: {
                        color: featureValues,
                        colorscale: 'Viridis',
                        size: 8,
                        showscale: i === 0,
                        colorbar: i === 0 ? {
                            title: 'Feature Value',
                            titleside: 'right'
                        } : undefined
                    },
                    name: plot.feature_names[i],
                    showlegend: false
                });
            }

            const layout = {
                title: 'SHAP Summary Plot',
                xaxis: {
                    title: 'SHAP value (impact on model output)',
                    showgrid: true,
                    zeroline: true
                },
                yaxis: {
                    title: 'Features',
                    showgrid: true
                },
                margin: { t: 50, r: 150, b: 100, l: 150 }
            };

            const config = {
                responsive: true,
                displayModeBar: true
            };

            Plotly.newPlot(containerId, traces, layout, config);
        }

        // Render partial dependence plot
        function renderPartialDependencePlot(plot, containerId) {
            const colors = getColors(plot.config?.color_scheme || 'Default');
            const traces = [];

            // Main PD curve
            traces.push({
                x: plot.feature_values,
                y: plot.pd_values,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Partial Dependence',
                line: {
                    color: colors[0],
                    width: 3
                },
                marker: {
                    color: colors[0],
                    size: 6
                }
            });

            // ICE curves if available
            if (plot.ice_curves && plot.show_ice) {
                for (let i = 0; i < plot.ice_curves.length; i++) {
                    traces.push({
                        x: plot.feature_values,
                        y: plot.ice_curves[i],
                        type: 'scatter',
                        mode: 'lines',
                        name: `ICE ${i}`,
                        line: {
                            color: colors[1] || '#cccccc',
                            width: 1
                        },
                        opacity: 0.3,
                        showlegend: i === 0
                    });
                }
            }

            const layout = {
                title: `Partial Dependence Plot - ${plot.feature_name}`,
                xaxis: {
                    title: plot.feature_name,
                    showgrid: true
                },
                yaxis: {
                    title: 'Partial Dependence',
                    showgrid: true
                },
                margin: { t: 50, r: 50, b: 100, l: 100 }
            };

            const config = {
                responsive: true,
                displayModeBar: true
            };

            Plotly.newPlot(containerId, traces, layout, config);
        }

        // Render comparative plot
        function renderComparativePlot(plot, containerId) {
            const colors = getColors(plot.config?.color_scheme || 'Default');
            const traces = [];
            
            let colorIndex = 0;
            for (const [modelName, data] of Object.entries(plot.model_data)) {
                traces.push({
                    x: plot.labels,
                    y: data.flat ? data.flat() : data[0], // Handle 2D arrays
                    type: 'bar',
                    name: modelName,
                    marker: {
                        color: colors[colorIndex % colors.length]
                    }
                });
                colorIndex++;
            }

            const layout = {
                title: 'Model Comparison',
                xaxis: {
                    title: 'Metrics',
                    showgrid: true
                },
                yaxis: {
                    title: 'Values',
                    showgrid: true
                },
                barmode: plot.comparison_type === 'SideBySide' ? 'group' : 'overlay',
                margin: { t: 50, r: 50, b: 100, l: 100 }
            };

            const config = {
                responsive: true,
                displayModeBar: true
            };

            Plotly.newPlot(containerId, traces, layout, config);
        }

        // Get colors for a scheme
        function getColors(scheme) {
            return colorSchemes[scheme] || colorSchemes.Default;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeVisualizations);
        
        // Real-time update functionality
        function updatePlotData(plotId, newData) {
            // This would be called from Rust for real-time updates
            console.log('Updating plot:', plotId, 'with data:', newData);
        }
        
        // Export functionality
        function exportPlot(containerId, format = 'png') {
            Plotly.downloadImage(containerId, {
                format: format,
                width: 1200,
                height: 800,
                filename: 'sklears_plot'
            });
        }
        
        // Add export buttons
        function addExportButton(containerId) {
            const container = document.getElementById(containerId).parentElement;
            const button = document.createElement('button');
            button.textContent = 'Export Plot';
            button.onclick = () => exportPlot(containerId);
            container.appendChild(button);
        }
    </script>
</body>
</html>